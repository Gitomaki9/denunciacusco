<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar Denuncia - Cusco Reporta</title>
  
  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="../css/registrar_Denuncia.css" />

  <style>
    /* Ajustes necesarios para que el mapa y los mensajes se vean bien */
    #mapContainer { width: 100%; height: 300px; border-radius: 12px; border: 1px solid #ddd; }
    .badge-warn { background:#fff3cd; color:#856404; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
    .badge-ok { background:#e8f7ea; color:#1c6b2a; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
    #msg { display: block; margin-top: 10px; font-size: 0.9rem; }
    .error { color: #b00020; font-weight: bold; }
    .ok { color: #1c6b2a; font-weight: bold; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar__logo">
      <img href="../css/images/CuscoReporta.png" alt="Cusco Reporta Logo">
    </div>
    <nav class="topbar__menu">
      <a href="/">Inicio</a>
      <a href="/sobre_nosotros">Sobre nosotros</a>
      <a href="/ayuda">Ayuda</a>
    </nav>
  </header>

  <div class="container" style="display:flex; gap:20px;">
    <aside class="sidebar">
      <div class="sidebar__user">
        <div class="sidebar__avatar"><i class="fa-solid fa-user"></i></div>
        <div class="sidebar__info">
          <h3 id="nombreUsuario">Invitado</h3>
          <p id="rolUsuario">—</p>
        </div>
      </div>

      <ul class="sidebar__menu">
        <li><a href="/perfil_usuario"><i class="fa-solid fa-id-card"></i><span>Ver perfil</span></a></li>
        <li><a href="/ReportarIncidencia"><i class="fa-solid fa-pen-to-square"></i><span>Reportar</span></a></li>
        <li><a href="/registrar_Denuncia" class="active"><i class="fa-solid fa-triangle-exclamation"></i><span>Denunciar</span></a></li>
        <li><a href="/lista_incidencias"><i class="fa-solid fa-list-check"></i><span>Estado de reportes</span></a></li>
        <li><a href="/MapaIncidiencias(Ciudadano)"><i class="fa-solid fa-map-location-dot"></i><span>Mapa de incidencias</span></a></li>
        <li><a href="/notificaciones"><i class="fa-solid fa-bell"></i><span>Notificaciones</span></a></li>
      </ul>

      <button class="logout-btn" id="logoutBtn" style="margin-top:auto;">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
      </button>
    </aside>

    <main class="main-content denuncia-form" style="flex:1;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Registrar Denuncia</h1>
        <div id="modoBox" class="badge-warn">
          <i class="fa-solid fa-user-secret"></i> <span id="modoTxt">Sesión anónima</span>
        </div>
      </div>

      <form id="formInc" class="formulario">
        <div class="fila">
          <div class="columna">
            <div class="campo">
              <label for="fecha_incidente">Fecha</label>
              <input type="date" id="fecha_incidente" required>
            </div>
            
            <div class="campo">
              <label for="titulo">Título de la denuncia</label>
              <input type="text" id="titulo" placeholder="Ej: Robo en paradero" required>
            </div>

            <div class="campo">
              <label for="distrito">Distrito</label>
              <select id="distrito" required>
                <option value="">Seleccione</option>
                <option value="Cusco">Cusco</option>
                <option value="Wanchaq">Wanchaq</option>
                <option value="San Sebastián">San Sebastián</option>
                <option value="San Jerónimo">San Jerónimo</option>
              </select>
            </div>

            <div class="campo">
              <label for="referencia_lugar">Referencia</label>
              <input type="text" id="referencia_lugar" placeholder="Referencia del lugar" required>
            </div>

            <div class="campo">
              <label for="categoria_id">Categoría / Tipo de incidente</label>
              <select id="categoria_id" required>
                <option value="">Cargando categorías...</option>
              </select>
            </div>

            <div class="campo">
              <label for="descripcion">Descripción de los hechos</label>
              <textarea id="descripcion" placeholder="Describa lo sucedido..." required></textarea>
            </div>

            <div class="campo">
              <label for="archivo">Evidencia (Imagen opcional)</label>
              <input type="file" id="archivo" accept="image/*">
            </div>
          </div>

          <div class="columna">
            <div class="campo">
              <label>Ubicar en el mapa</label>
              <div id="mapContainer">
                <div id="map" style="width:100%; height:100%;"></div>
              </div>
              <input type="hidden" id="lat">
              <input type="hidden" id="lng">
            </div>

            <div class="campo" style="display:flex; gap:10px;">
              <button type="button" class="btn-secundario" id="btnVictima" style="flex:1;">Datos de la víctima</button>
              <button type="button" class="btn-secundario" id="btnDenunciado" style="flex:1;">Datos del denunciado</button>
            </div>

            <div class="campo" style="text-align:center;">
              <button type="submit" class="btn-principal" id="btnEnviar" style="margin-top:15px; width: 100%;">
                <i class="fa-solid fa-paper-plane"></i> Enviar Denuncia
              </button>
              <p id="msg" class="muted"></p>
            </div>
          </div>
        </div>
      </form>
    </main>
  </div>

  <div class="modal" id="modalVictima">
    <div class="modal-content">
      <span class="close-modal" id="closeVictima">&times;</span>
      <h3>Datos de la víctima</h3>
      <input type="text" id="v_nombre" placeholder="Nombre completo"><br><br>
      <input type="text" id="v_dni" placeholder="DNI"><br><br>
      <input type="text" id="v_tel" placeholder="Teléfono">
    </div>
  </div>

  <div class="modal" id="modalDenunciado">
    <div class="modal-content">
      <span class="close-modal" id="closeDenunciado">&times;</span>
      <h3>Datos del denunciado</h3>
      <input type="text" id="d_nombre" placeholder="Nombre o alias"><br><br>
      <input type="text" id="d_descripcion" placeholder="Descripción física o rasgos"><br><br>
      <input type="text" id="d_placa" placeholder="Placa (si aplica)">
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:3000";

    // --- LÓGICA DE SESIÓN ---
    function getModo() {
      const modo = localStorage.getItem("modo_denuncia");
      const token = localStorage.getItem("token");
      const userRaw = localStorage.getItem("user");
      if (modo === "incognito") return { modo: "incognito", token: null, user: null };
      if (token) {
        try { return { modo: "identificado", token, user: JSON.parse(userRaw) }; } catch { }
      }
      return { modo: "incognito", token: null, user: null };
    }

    function pintarModo() {
      const { modo, user } = getModo();
      const nombreEl = document.getElementById("nombreUsuario");
      const rolEl = document.getElementById("rolUsuario");
      const box = document.getElementById("modoBox");
      const txt = document.getElementById("modoTxt");

      if (modo === "identificado") {
        box.className = "badge-ok";
        txt.innerHTML = "Sesión identificada";
        nombreEl.textContent = user?.nombre_completo || user?.username || "Usuario";
        rolEl.textContent = user?.rol_id === 2 ? "Administrador" : "Ciudadano";
      } else {
        box.className = "badge-warn";
        txt.innerHTML = "Sesión anónima";
        nombreEl.textContent = "Invitado";
        rolEl.textContent = "—";
      }
    }

    // --- LÓGICA DE MAPA ---
    let map, marker;
    function initMap() {
      const latDefault = -13.53195;
      const lngDefault = -71.96746;
      map = L.map("map").setView([latDefault, lngDefault], 14);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      marker = L.marker([latDefault, lngDefault], { draggable: true }).addTo(map);
      
      const updateCoords = (lat, lng) => {
        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
      };

      updateCoords(latDefault, lngDefault);
      map.on("click", (e) => {
        marker.setLatLng(e.latlng);
        updateCoords(e.latlng.lat, e.latlng.lng);
      });
      marker.on("dragend", () => {
        const p = marker.getLatLng();
        updateCoords(p.lat, p.lng);
      });
    }

    // --- CARGAR CATEGORÍAS ---
    async function cargarCategorias() {
      const sel = document.getElementById("categoria_id");
      try {
        const res = await fetch(`${API_BASE}/categorias_incidencia`);
        const data = await res.json();
        const cats = Array.isArray(data) ? data : data.categorias || [];
        sel.innerHTML = '<option value="">Seleccione</option>';
        cats.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id || c.categoria_id;
          opt.textContent = c.nombre || c.categoria || c.descripcion;
          sel.appendChild(opt);
        });
      } catch (e) {
        sel.innerHTML = '<option value="">Error al cargar</option>';
      }
    }

    // --- MODALES ---
    const setupModal = (btnId, modalId, closeId) => {
      const btn = document.getElementById(btnId);
      const modal = document.getElementById(modalId);
      const close = document.getElementById(closeId);
      btn.onclick = () => modal.style.display = "block";
      close.onclick = () => modal.style.display = "none";
      window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };
    };

    // --- ENVÍO DE FORMULARIO ---
    document.addEventListener("DOMContentLoaded", () => {
      pintarModo();
      initMap();
      cargarCategorias();
      setupModal("btnVictima", "modalVictima", "closeVictima");
      setupModal("btnDenunciado", "modalDenunciado", "closeDenunciado");

      document.getElementById("logoutBtn").onclick = () => {
        localStorage.clear();
        window.location.href = "index.html";
      };

      document.getElementById("formInc").onsubmit = async (e) => {
        e.preventDefault();
        const msg = document.getElementById("msg");
        msg.textContent = "Enviando...";
        msg.className = "muted";

        const { modo, token } = getModo();
        const fd = new FormData();
        
        // Campos principales
        fd.append("fecha_incidente", document.getElementById("fecha_incidente").value);
        fd.append("titulo", document.getElementById("titulo").value);
        fd.append("distrito", document.getElementById("distrito").value);
        fd.append("referencia_lugar", document.getElementById("referencia_lugar").value);
        fd.append("categoria_id", document.getElementById("categoria_id").value);
        fd.append("descripcion", document.getElementById("descripcion").value);
        fd.append("lat", document.getElementById("lat").value);
        fd.append("lng", document.getElementById("lng").value);
        fd.append("modo", modo);

        // Campos adicionales (Modales)
        fd.append("victima_nombre", document.getElementById("v_nombre").value);
        fd.append("denunciado_nombre", document.getElementById("d_nombre").value);

        const file = document.getElementById("archivo").files[0];
        if (file) fd.append("archivo", file);

        try {
          const res = await fetch(`${API_BASE}/incidencias/create`, {
            method: "POST",
            headers: token ? { "Authorization": `Bearer ${token}` } : {},
            body: fd
          });
          if (res.ok) {
            msg.textContent = "✅ Denuncia registrada con éxito";
            msg.className = "ok";
            document.getElementById("formInc").reset();
          } else {
            throw new Error();
          }
        } catch (err) {
          msg.textContent = "❌ Error al enviar. Intente más tarde.";
          msg.className = "error";
        }
      };
    });
  </script>
</body>
</html>